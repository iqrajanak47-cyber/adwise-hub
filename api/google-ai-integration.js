// Google AI Studio Integration for Money Advise Hub
const GOOGLE_AI_API_KEY = 'AIzaSyBGBvisMUklr_swayUPHV-n4VJL-eK-ZLU'; // Replace with your key from https://aistudio.google.com/app/apikey
const GOOGLE_AI_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GOOGLE_AI_API_KEY}`;
const IMAGE_GEN_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:generateImage?key=${GOOGLE_AI_API_KEY}`;

// Generate images using Google AI Studio
async function generateArticleImage(topic, category) {
  const imagePrompt = `Create a professional, clean illustration for a financial article about "${topic}". Style: modern, minimalist, business-focused, suitable for a financial website. Colors: blue, green, white. No text overlay. High quality, web-optimized.`;

  try {
    const response = await fetch(IMAGE_GEN_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        prompt: imagePrompt,
        config: {
          aspectRatio: '16:9',
          safetyFilterLevel: 'BLOCK_ONLY_HIGH',
          personGeneration: 'DONT_ALLOW'
        }
      })
    });

    if (response.ok) {
      const data = await response.json();
      if (data.candidates && data.candidates[0]) {
        return data.candidates[0].image.uri;
      }
    }
  } catch (error) {
    console.error('Image generation failed:', error);
  }
  
  // Fallback to placeholder
  return `https://via.placeholder.com/800x450/2c5aa0/ffffff?text=${encodeURIComponent(topic)}`;
}

// Generate financial content using Google AI Studio
async function generateFinancialArticle(topic, category) {
  const prompt = `Write a comprehensive financial article for US residents about "${topic}".

Requirements:
- 800-1200 words
- SEO optimized with H2 and H3 headings
- Include practical advice and current market data
- Add a call-to-action section
- Focus on USA financial regulations and products
- Use HTML formatting with proper tags
- Include bullet points and numbered lists where appropriate

Category: ${category}
Target Audience: US residents seeking financial advice

Format the response as clean HTML content ready for publication.`;

  try {
    const response = await fetch(GOOGLE_AI_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        contents: [{
          parts: [{ text: prompt }]
        }],
        generationConfig: {
          temperature: 0.7,
          topK: 40,
          topP: 0.95,
          maxOutputTokens: 2048,
        }
      })
    });

    if (!response.ok) {
      throw new Error(`Google AI API error: ${response.status}`);
    }

    const data = await response.json();
    
    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
      return data.candidates[0].content.parts[0].text;
    } else {
      throw new Error('No content generated by AI');
    }

  } catch (error) {
    console.error('Google AI generation failed:', error);
    
    // Fallback content template with image
    const fallbackImage = `https://via.placeholder.com/800x450/2c5aa0/ffffff?text=${encodeURIComponent(topic)}`;
    return `
      <div class="article-hero-image">
        <img src="${fallbackImage}" alt="${topic}" class="img-fluid rounded mb-4" loading="lazy">
      </div>
      <h2>Understanding ${topic}</h2>
      <p>This comprehensive guide covers everything US residents need to know about ${topic.toLowerCase()}.</p>
      
      <h3>Key Benefits</h3>
      <ul>
        <li>Competitive rates and terms available in the US market</li>
        <li>Flexible qualification requirements for American consumers</li>
        <li>Quick approval processes with major US providers</li>
        <li>Excellent customer service and support</li>
      </ul>
      
      <h3>How to Get Started</h3>
      <p>Follow these steps to find the best ${topic.toLowerCase()} options for your needs:</p>
      <ol>
        <li>Compare rates from multiple US providers</li>
        <li>Check your credit score and financial standing</li>
        <li>Read reviews and customer testimonials</li>
        <li>Apply with your preferred provider</li>
      </ol>
      
      <div class="cta-box">
        <h3>Ready to Take Action?</h3>
        <p>Compare your options and find the best ${topic.toLowerCase()} solution for your financial needs today.</p>
      </div>
    `;
  }
}

// Enhanced daily content generator with Google AI
async function generateDailyContentWithAI() {
  const topics = [
    { topic: 'Best Credit Cards for Americans 2025', category: 'Finance' },
    { topic: 'Personal Loan Rates This Week', category: 'Loans' },
    { topic: 'Cheapest Car Insurance by State', category: 'Insurance' },
    { topic: 'Mortgage Refinancing Guide', category: 'Real Estate' },
    { topic: 'High Yield Savings Accounts', category: 'Banking' },
    { topic: 'Investment Apps for Beginners', category: 'Investing' },
    { topic: 'Small Business Loan Options', category: 'Business' },
    { topic: 'Tax Deductions You Can Claim', category: 'Taxes' },
    { topic: 'Retirement Planning in Your 30s', category: 'Retirement' },
    { topic: 'Emergency Fund Calculator', category: 'Budgeting' }
  ];

  const today = new Date();
  const dayIndex = today.getDate() % topics.length;
  const selectedTopic = topics[dayIndex];

  console.log(`ü§ñ Generating AI content: ${selectedTopic.topic}`);
  console.log(`üé® Generating article image...`);

  try {
    // Generate image first
    const imageUrl = await generateArticleImage(selectedTopic.topic, selectedTopic.category);
    
    // Generate content
    const aiContent = await generateFinancialArticle(selectedTopic.topic, selectedTopic.category);
    
    // Add image to content
    const contentWithImage = `
      <div class="article-hero-image">
        <img src="${imageUrl}" alt="${selectedTopic.topic}" class="img-fluid rounded mb-4" loading="lazy">
      </div>
      ${aiContent}
    `;
    
    // Upload to website
    const uploadResponse = await fetch('https://adwise-oylki82ud-iqrajans-projects.vercel.app/api/upload-content.php', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer mah-api-key-2025'
      },
      body: JSON.stringify({
        title: selectedTopic.topic,
        content: contentWithImage,
        category: selectedTopic.category,
        source: 'Google AI Studio + Imagen',
        imageUrl: imageUrl
      })
    });

    const result = await uploadResponse.json();
    
    if (result.success) {
      console.log(`‚úÖ AI article published: ${result.url}`);
      return result;
    } else {
      console.error(`‚ùå Upload failed: ${result.error}`);
      return null;
    }

  } catch (error) {
    console.error('‚ùå AI content generation failed:', error);
    return null;
  }
}

// Test function for Google AI integration
async function testGoogleAI() {
  console.log('üß™ Testing Google AI Studio integration...');
  
  const testTopic = 'Best Credit Cards for 2025';
  const testCategory = 'Finance';
  
  const content = await generateFinancialArticle(testTopic, testCategory);
  console.log('Generated content preview:', content.substring(0, 200) + '...');
  
  return content;
}

// Export functions
if (typeof module !== 'undefined') {
  module.exports = { 
    generateFinancialArticle, 
    generateArticleImage,
    generateDailyContentWithAI, 
    testGoogleAI 
  };
}

// Usage instructions
console.log(`
ü§ñ Google AI Studio Integration Setup:

1. Get your API key: https://aistudio.google.com/app/apikey
2. Replace YOUR_GOOGLE_AI_STUDIO_API_KEY with your actual key
3. Test the integration: node google-ai-integration.js
4. Run daily generation: generateDailyContentWithAI()

Features:
‚úÖ Gemini Pro model integration
‚úÖ Financial content optimization
‚úÖ USA-focused content
‚úÖ SEO-ready HTML output
‚úÖ Automatic article publishing
`);